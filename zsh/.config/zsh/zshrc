#!/usr/bin/env zsh


#          _
#  _______| |__  _ __ ___
# |_  / __| '_ \| '__/ __|
#  / /\__ \ | | | | | (__
# /___|___/_| |_|_|  \___|
# ~/.config/zsh/zshrc


# >>> Common settings

profile="${HOME}/.profile"
[ -e "${profile}" ] && source "${profile}"


# >>> History

# Necessary to save history
HISTFILE=${ZCACHEDIR}/history
HISTSIZE=50000
SAVEHIST=${HISTSIZE}

# Ignore duplicates
setopt hist_ignore_all_dups

# Ignore space
setopt hist_ignore_space

# Save immediatelly, share history between terminals
setopt share_history


# >>> Completion

# Extendedglob
setopt extendedglob

# Load compinit
autoload -U compinit
compinit -d ${ZCACHEDIR}/compdump

# Advanced tab-completion
zstyle ':completion:*:descriptions' format '%U%B%d%b%u'
zstyle ':completion:*:warnings' format '%BSorry, no matches for: %d%b'
zstyle ':completion:*' menu select

# Correction
setopt correctall

# Racket completion
source_file "/usr/share/racket/pkgs/shell-completion/racket-completion.zsh"


# >>> Key bindings

# Kill & Yank
# for this set Emacs key bindings
bindkey -e

# Ctrl-left and Ctrl-right
bindkey "^[[1;5D" backward-word
bindkey "^[[1;5C" forward-word

# Del, Home and End
bindkey "^[[3~" delete-char
bindkey "^[[H" beginning-of-line
bindkey "^[[F" end-of-line

# Reverse search
bindkey "^R" history-incremental-search-backward

# Remove C-d binding (list-choices/delete-char-or-list)
bindkey -r "^D"


# >>> Prompt theme

# Prompt init
autoload -U promptinit
promptinit

# Source appropriate theme
if [ -z ${DISPLAY} ]; then
    # theme in tty
    source_file "${ZDOTDIR}/tty.zsh-theme"
else
    # theme in emulators
    source_file "${ZDOTDIR}/emu.zsh-theme"
fi


# >>> Plugins

# Syntax coloring
source_file "${ZDOTDIR}/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"

# Autosuggestions
source_file "${ZDOTDIR}/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh"

# Autosuggestions highlight style
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=6"

# Completion for kitty
if command_exists kitty
then
    kitty + complete setup zsh | source /dev/stdin
fi


# >>> ZSH tweaks

# Prompt Substring
# used by git_check
setopt PROMPT_SUBST

# Color
use_color=true

# Directory name to change dir
setopt autocd

# Do not beep
unsetopt beep

# Command Editor
autoload -U edit-command-line
zle -N edit-command-line
bindkey "^X^E" edit-command-line

case ${TERM} in
    xterm* )
        # Change the window title of X terminals
        precmd() {
            print -Pn "\e]0;${USER}@${HOST}:${PWD/#$HOME/\~}\a"
        }
        ;;
    dumb )
        # For some SSH sessions (Emacs)
        unsetopt zle
        unsetopt prompt_cr
        unsetopt prompt_subst
        unfunction precmd
        unfunction preexec
        PS1='$ '
        ;;
esac

# ls after changing directory
chpwd() ls

#!/usr/bin/env bash

# in cronjob use with >/dev/null

count_backups() {
    find "$backup_dir" -maxdepth 1 -type f -name "$target_base*.tar.gz" | wc -l
}

tarup() {
    tar -zcf "$backup_dir/$target_base-$(date +"%Y-%m-%d-%H-%M").tar.gz" $target_dir
}

rm_old() {
    rm "$(ls "$backup_dir"/"$target_base"* -t1r | sed 1q)"
}

if [ -z $1 ] || [ -z $2 ]; then
    echo "ERROR: Missing variables!"
    echo "usage:"
    echo "bak-dir <directory to backup> <directory to backup into>"
    echo "example:"
    echo "bak-dir ~/Pictures ~/Data/Backup"
    exit 1
else
    target_dir=$1
    target_base=$(basename $target_dir)
    backup_dir=$2
    if [ "$(count_backups)" -lt 3 ]; then
        tarup
    else
        rm_old
        tarup
    fi
fi

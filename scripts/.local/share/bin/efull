#!/usr/bin/env bash


# Upgrade your Gentoo box


trap 'exit 128' INT
export PATH


STEP=0


umsg() {
    ((STEP++))
    echo "$(tput bold)$(tput setaf 7) [$(tput setaf 2)${STEP}$(tput setaf 7)] ${1} $(tput sgr0)"
}

main() {
    umsg "Syncing the tree"
    eix-sync
    eix-remote update

    umsg "Upgrading portage"
    emerge -1u sys-apps/portage

    umsg "Merging changes"
    emerge --changed-deps --changed-slot @world

    umsg "Upgrading system"
    emerge -uNUD --with-bdeps=y @world

    umsg "Upgrading git packages"
    smart-live-rebuild -j 2

    umsg "Cleaning"
    emerge -c
    eclean-dist --deep
}


if [ "$(whoami)" != root ]; then
    sudo "${0}"
else
    main
fi

#!/usr/bin/env bash


# This file is part of mydot.

# mydot is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# mydot is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with mydot.  If not, see <https://www.gnu.org/licenses/>.

# Copyright (c) 2020, XGQT
# Licensed under the GNU GPL v3 License

# Upgrade your Gentoo box


trap 'exit 128' INT
export PATH


STEP=0


umsg() {
    ((STEP++))
    echo "$(tput bold)$(tput setaf 7) [$(tput setaf 2)${STEP}$(tput setaf 7)] ${1} $(tput sgr0)"
}

command_exists () {
    if command -v "${1}" >/dev/null 2>&1
    then
        return 0
    else
        return 1
    fi
}

main() {
    if command_exists update-genlica
    then
        umsg "Updating Genlica"
        time update-genlica
    fi

    umsg "Syncing the tree"
    time eix-sync
    time eix-remote update

    umsg "Updating portage"
    time emerge -1u sys-apps/portage

    umsg "Merging changes"
    time emerge --changed-deps --changed-slot @world

    umsg "Updating system"
    time emerge -uNUD --with-bdeps=y @world

    umsg "Rebuilding Perl packages"
    time perl-cleaner --all

    if command_exists haskell-updater
    then
        umsg "Rebuilding Haskell packages"
        time haskell-updater -- --usepkg-exclude "*"
    fi

    umsg "Rebuilding preserved packages"
    time emerge -1v @preserved-rebuild

    if command_exists smart-live-rebuild
    then
        umsg "Updating git packages"
        time smart-live-rebuild -j 2
    fi

    umsg "Cleaning"
    time emerge -c
    time eclean-dist --deep
}


if [ "$(whoami)" != root ]
then
    echo "Switching to the root user account"
    sudo "${0}"
else
    main
fi
